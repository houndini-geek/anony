import{initializeApp}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";import{getAuth,signInAnonymously,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";import{getFirestore,collection,doc,getDoc,setDoc,updateDoc}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";import{v4 as uuidv4}from"https://jspm.dev/uuid";import{ref}from"vue";const firebaseConfig={apiKey:"AIzaSyCRPxwRZezkFcsPuojLK_258hTY1s2BfKk",authDomain:"listify-5fd65.firebaseapp.com",projectId:"listify-5fd65",storageBucket:"listify-5fd65.appspot.com",messagingSenderId:"54858603391",appId:"1:54858603391:web:52d177eb7648cf684f584a",measurementId:"G-B4C45TZBWC"};initializeApp(firebaseConfig);const auth=getAuth(),db=getFirestore();async function signIn(e){const s=e.value,t=ref("");if(s)return await signInAnonymously(auth).then((()=>{createUser(s)})).catch((e=>{console.log(e.message),t.value="Failed to create Anony account "+e.message})),{mssg:t}}async function createUser(e){const s=auth.currentUser.uid,t=e;if(!t)return alert("Anony username required");if(s)try{const e=collection(db,"users"),r=doc(e,s);return(await getDoc(r)).exists()?(console.log("User already exists"),void alert("User already exists")):(await setDoc(r,{username:t,uid:s,messages:[]}),console.log("User created successfully"),alert("User created successfully"),void setTimeout((()=>{location.href="/inbox"}),2e3))}catch(e){console.log(e.message),alert("Failed to create user: "+e.message)}}async function getUserData(){return new Promise(((e,s)=>{onAuthStateChanged(auth,(async t=>{if(!t)return console.log("User does not exist"),alert("User does not exist"),s("User does not exist"),void(location.href="/session");{const r=t.uid,o=collection(db,"users"),n=doc(o,r),a=await getDoc(n);if(!a.exists())return console.log("Doc not found."),alert("Error occured while triying to retrive your data, Create a new Anony acccount"),s("Doc not found"),void(location.href="/session");{const s=a.data();e(s)}}}))}))}async function deleteMssg(e){const s=auth.currentUser.uid;return s?new Promise(((t,r)=>{const o=collection(db,"users"),n=doc(o,s);getDoc(n).then((s=>{if(s.exists()){const o=s.data().messages;if(!o)return r({error:"No messages found."}),alert("No messages found.");const a=o.filter((s=>s.id!==e));a.length<o.length?updateDoc(n,{messages:a}).then((()=>{t({success:"Message deleted successfully."}),alert("Message deleted successfully!")})).catch((e=>{r({error:"An error occurred while deleting the message."+e}),alert("An error occurred while deleting the message.")})):(r({error:"Message not found."}),alert("Message not found."))}else r({error:"User document not found."}),alert("An error occurred. Please try refreshing the page.")})).catch((e=>{r({error:"An error occurred while fetching user data."+e}),alert("An error occurred while fetching user data.")}))})):alert("An error occurred. Please try refreshing the page.")}async function getReceiverName(e){const s=e,t=ref("");return s?new Promise(((e,r)=>{const o=collection(db,"users"),n=doc(o,s);getDoc(n).then((s=>{if(s.exists()){const r=s.data().username;t.value=r,e(t)}else r("Cannot find the user doc")}))})):alert("Anony user not found")}function getCurrentDate(){return(new Date).toLocaleDateString("en-US",{weekday:"short",month:"long",day:"numeric",hour:"numeric",minute:"numeric"})}async function sendAnonyMssg(e,s){const t=e,r=s.value;if(t&&r)return new Promise(((e,s)=>{const o=collection(db,"users"),n=doc(o,t);getDoc(n).then((t=>{if(t.exists()){const o=t.data().messages||[];o.push({message:r,id:uuidv4(),date:getCurrentDate()}),updateDoc(n,{messages:o}).then((()=>{e({success:"Your Anonymous message has been sent succesfuly"}),console.log("sent")})).catch((e=>{s(e.message),console.log(e.message)}))}else s({error:"An error occurred while sending the message"})}))}))}async function checkUser(){return new Promise((e=>{const s=ref(!1);onAuthStateChanged(auth,(t=>{t?(s.value=!0,e(s)):console.log("User not authenticated")}))}))}export{signIn,createUser,getUserData,getReceiverName,sendAnonyMssg,checkUser,deleteMssg};